# Personal AI 项目数据流和处理流程

## 1. 数据收集流程 (Data Collection Flow)

### 1.1 初始化阶段
```mermaid
graph TD
    A[脚本启动] --> B{数据库表存在?}
    B -->|否| C[创建表结构]
    B -->|是| D[开始数据导入]
    C --> D
```

### 1.2 笔记数据收集流程
```mermaid
graph TD
    A[笔记目录] --> B[递归扫描.md文件]
    B --> C[解析frontmatter元数据]
    C --> D[读取文件内容]
    D --> E{数据库中存在?}
    E -->|是| F[更新记录]
    E -->|否| G[插入新记录]
    F --> H[提交事务]
    G --> H
```

### 1.3 博客数据收集流程
```mermaid
graph TD
    A[博客目录] --> B[递归扫描.md文件]
    B --> C[解析frontmatter元数据]
    C --> D[读取文件内容]
    D --> E{数据库中存在?}
    E -->|是| F[更新记录]
    E -->|否| G[插入新记录]
    F --> H[提交事务]
    G --> H
```

### 1.4 照片数据收集流程
```mermaid
graph TD
    A[照片目录] --> B[扫描图片文件]
    B --> C[提取EXIF信息]
    C --> D{数据库中存在?}
    D -->|是| E[更新记录]
    D -->|否| F[插入新记录]
    E --> G[提交事务]
    F --> G
```

## 2. 数据处理流程 (Data Processing Flow)

### 2.1 数据摘要处理流程
```mermaid
graph TD
    A[查询未处理数据] --> B{有待处理数据?}
    B -->|否| C[结束处理]
    B -->|是| D[调用LLM生成摘要]
    D --> E[调用LLM生成标签]
    E --> F[更新数据库记录]
    F --> G[提交事务]
    G --> A
```

### 2.2 文本摘要流程
```mermaid
graph TD
    A[文本文件] --> B[读取文件内容]
    B --> C[构造LLM提示词]
    C --> D[调用文本LLM]
    D --> E[解析JSON响应]
    E --> F[返回摘要和标签]
```

### 2.3 图片摘要流程
```mermaid
graph TD
    A[图片文件] --> B{需要格式转换?}
    B -->|是HEIC| C[转换为JPG]
    B -->|是RAW| D[转换为JPG]
    B -->|否| E[直接处理]
    C --> E
    D --> E
    E --> F[构造视觉LLM提示词]
    F --> G[调用视觉LLM]
    G --> H[解析JSON响应]
    H --> I[返回描述和标签]
```

## 3. 向量索引流程 (Vector Indexing Flow)

### 3.1 向量索引构建流程
```mermaid
graph TD
    A[启动索引构建] --> B[获取所有数据记录]
    B --> C[格式化数据为文本]
    C --> D[生成向量嵌入]
    D --> E[创建UnifiedEmbedding记录]
    E --> F[保存到向量数据库]
    F --> G{还有更多记录?}
    G -->|是| C
    G -->|否| H[提交事务]
```

### 3.2 数据格式化流程
```mermaid
graph TD
    A[数据记录] --> B{记录类型?}
    B -->|笔记| C[格式化笔记文本]
    B -->|博客| D[格式化博客文本]
    B -->|照片| E[格式化照片文本]
    C --> F[统一文本格式]
    D --> F
    E --> F
```

## 4. 知识图谱构建流程 (Knowledge Graph Building Flow)

### 4.1 知识图谱构建流程
```mermaid
graph TD
    A[启动知识图谱构建] --> B[获取所有数据记录]
    B --> C[提取实体]
    C --> D[提取关系]
    D --> E[创建图节点]
    E --> F[创建图关系]
    F --> G[保存到图数据库]
    G --> H{还有更多记录?}
    H -->|是| C
    H -->|否| I[提交事务]
```

### 4.2 实体提取流程
```mermaid
graph TD
    A[数据记录] --> B{记录类型?}
    B -->|笔记| C[提取笔记实体]
    B -->|博客| D[提取博客实体]
    B -->|照片| E[提取照片实体]
    C --> F[统一实体格式]
    D --> F
    E --> F
```

### 4.3 关系提取流程
```mermaid
graph TD
    A[数据记录] --> B[提取实体]
    B --> C[识别实体间关系]
    C --> D[创建关系边]
    D --> E[保存关系]
```

## 5. 查询处理流程 (Query Processing Flow)

### 5.1 API 查询处理流程
```mermaid
graph TD
    A[接收API请求] --> B[解析请求参数]
    B --> C[提取用户问题]
    C --> D{检索类型?}
    D -->|向量检索| E[向量检索引擎]
    D -->|图检索| F[图检索引擎]
    D -->|混合检索| G[结果融合器]
    E --> H[向量数据库查询]
    F --> I[图数据库查询]
    G --> H
    G --> I
    H --> J[检索相关文档]
    I --> K[检索相关实体]
    J --> L[构造上下文提示词]
    K --> L
    L --> M[调用LLM生成回答]
    M --> N[返回响应]
```

### 5.2 向量检索流程
```mermaid
graph TD
    A[用户问题] --> B[生成问题向量]
    B --> C[向量数据库查询]
    C --> D[计算余弦相似度]
    D --> E[排序并限制结果数量]
    E --> F[返回相似文档]
```

### 5.3 图检索流程
```mermaid
graph TD
    A[用户问题] --> B[解析查询意图]
    B --> C[图数据库查询]
    C --> D[执行图遍历]
    D --> E[返回相关实体和关系]
```

### 5.4 结果融合流程
```mermaid
graph TD
    A[向量检索结果] --> C[结果融合器]
    B[图检索结果] --> C
    C --> D[加权评分]
    D --> E[排序结果]
    E --> F[返回融合结果]
```

### 5.5 回答生成流程
```mermaid
graph TD
    A[检索到的文档和实体] --> B[构造上下文]
    B --> C[构造完整提示词]
    C --> D[调用LLM]
    D --> E[生成回答]
    E --> F{流式输出?}
    F -->|是| G[分块返回]
    F -->|否| H[完整返回]
```

## 6. 完整数据生命周期 (Complete Data Lifecycle)

```mermaid
graph TD
    A[原始数据源] --> B[数据收集]
    B --> C[数据存储]
    C --> D[数据摘要]
    D --> E[数据增强]
    E --> F[向量索引]
    F --> G[向量存储]
    E --> H[知识图谱构建]
    H --> I[图存储]
    G --> J[用户查询]
    I --> J
    J --> K[检索引擎]
    K --> L[上下文构建]
    L --> M[LLM回答]
    M --> N[响应返回]
    
    subgraph 数据准备阶段
        B
        C
        D
        E
        F
        G
        H
        I
    end
    
    subgraph 查询服务阶段
        J
        K
        L
        M
        N
    end
```

## 7. 关键处理步骤详解

### 7.1 数据收集阶段
1. **脚本启动**: 运行 `scripts/import_personal_data.py`
2. **表结构检查**: 确保数据库表已创建
3. **笔记收集**: 扫描笔记目录，解析 Markdown 文件
4. **博客收集**: 扫描博客目录，解析 Markdown 文件
5. **照片收集**: 扫描照片目录，提取 EXIF 信息

### 7.2 数据处理阶段
1. **摘要生成**: 对未处理的数据调用 LLM 生成摘要和标签
2. **文本处理**: 使用文本 LLM 分析文本内容
3. **图片处理**: 使用视觉 LLM 分析图片内容
4. **格式转换**: 对特殊格式图片（HEIC、RAW）进行转换

### 7.3 向量索引阶段
1. **数据读取**: 从数据库读取完整的结构化数据
2. **格式化**: 使用格式化器将数据转换为统一文本格式
3. **嵌入生成**: 调用嵌入模型生成向量表示
4. **索引存储**: 将向量嵌入存储到向量数据库

### 7.4 知识图谱构建阶段
1. **数据读取**: 从数据库读取完整的结构化数据
2. **实体提取**: 从数据中提取实体信息
3. **关系提取**: 识别实体间的关系
4. **图构建**: 在图数据库中创建节点和关系

### 7.5 查询服务阶段
1. **请求接收**: API 服务器接收用户查询请求
2. **检索执行**: 根据查询类型执行向量检索、图检索或混合检索
3. **结果融合**: 融合多种检索方式的结果
4. **上下文构建**: 将检索到的内容构造成上下文提示词
5. **回答生成**: 调用 LLM 生成基于上下文的回答
6. **响应返回**: 将回答返回给用户

## 8. 并发处理和性能考虑

### 8.1 批量处理
- 数据收集和摘要处理使用批量操作提高效率
- 使用 tqdm 显示进度条，提供用户反馈

### 8.2 错误处理
- 各个处理步骤都有异常捕获机制
- 失败的文件不会影响整体处理流程
- 提供详细的错误日志便于调试

### 8.3 增量处理
- 数据收集支持增量更新，避免重复处理
- 摘要生成只处理未处理或需要更新的数据

## 9. 配置驱动
- 所有路径和参数通过环境变量配置
- 支持不同的模型配置和 API 设置
- 灵活的配置管理便于部署和测试